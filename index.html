<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pastefy Clone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    pre { max-height: 70vh; overflow: auto; }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen flex flex-col items-center p-6">

  <!-- Header -->
  <header class="w-full max-w-5xl flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-blue-400 cursor-pointer" onclick="goHome()">PasteClone</h1>
    <nav class="space-x-4">
      <button onclick="newPaste()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700">New</button>
      <button onclick="clearAll()" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700">Clear All</button>
    </nav>
  </header>

  <!-- Form nhập -->
  <main id="editor" class="w-full max-w-5xl grid md:grid-cols-2 gap-6">
    <div class="bg-gray-800 p-5 rounded-2xl shadow-xl flex flex-col">
      <input id="title" type="text" placeholder="Tiêu đề paste..." 
        class="w-full mb-3 p-3 rounded-lg bg-gray-700 text-white outline-none">
      <textarea id="content" rows="14" placeholder="Nhập text/code tại đây..."
        class="flex-1 w-full p-3 rounded-lg bg-gray-700 text-white outline-none font-mono text-sm"></textarea>
      <button onclick="savePaste()" 
        class="mt-4 px-4 py-2 bg-green-500 hover:bg-green-600 rounded-xl font-semibold">Lưu Paste</button>
    </div>

    <!-- Danh sách paste -->
    <div>
      <h2 class="text-2xl font-semibold mb-4">Danh sách Paste</h2>
      <div id="pasteList" class="space-y-4"></div>
    </div>
  </main>

  <!-- Modal hiển thị paste -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-gray-900 w-11/12 md:w-2/3 lg:w-1/2 p-6 rounded-2xl shadow-2xl relative">
      <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white">✕</button>
      <h3 id="modalTitle" class="text-xl font-bold mb-3"></h3>
      <pre><code id="modalContent" class="language-javascript"></code></pre>
      <div class="mt-4 flex space-x-3">
        <button onclick="copyModal()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">Copy</button>
        <button onclick="downloadModal()" class="px-3 py-2 bg-green-600 hover:bg-green-700 rounded-lg">Download</button>
        <button onclick="shareModal()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg">Share Link</button>
      </div>
      <p id="shareLink" class="mt-3 text-sm text-blue-400 break-words"></p>
    </div>
  </div>

  <script>
    let currentPaste = null;

    function savePaste() {
      const title = document.getElementById("title").value || "Untitled";
      const content = document.getElementById("content").value.trim();
      if (!content) return alert("Nội dung trống!");

      const paste = { id: Date.now(), title, content };
      let pastes = JSON.parse(localStorage.getItem("pastes") || "[]");
      pastes.unshift(paste);
      localStorage.setItem("pastes", JSON.stringify(pastes));

      window.location.hash = paste.id;
      openPasteById(paste.id);
      loadPastes();
    }

    function loadPastes() {
      const pasteList = document.getElementById("pasteList");
      pasteList.innerHTML = "";
      let pastes = JSON.parse(localStorage.getItem("pastes") || "[]");

      if (pastes.length === 0) {
        pasteList.innerHTML = `<p class='text-gray-400'>Chưa có paste nào.</p>`;
      }

      pastes.forEach(paste => {
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-4 rounded-xl shadow hover:bg-gray-700 cursor-pointer";
        div.innerHTML = `
          <h3 class="text-lg font-bold">${paste.title}</h3>
          <p class="text-gray-400 text-sm truncate">${paste.content}</p>
        `;
        div.onclick = () => {
          window.location.hash = paste.id;
          openPasteById(paste.id);
        };
        pasteList.appendChild(div);
      });
    }

    function openPasteById(id) {
      let pastes = JSON.parse(localStorage.getItem("pastes") || "[]");
      let paste = pastes.find(p => p.id == id);
      if (!paste) return;
      currentPaste = paste;

      document.getElementById("modalTitle").textContent = paste.title;
      const modalContent = document.getElementById("modalContent");
      modalContent.textContent = paste.content;
      Prism.highlightElement(modalContent);

      document.getElementById("modal").classList.remove("hidden");
      document.getElementById("shareLink").textContent = "";
    }

    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
      currentPaste = null;
      window.location.hash = "";
    }

    function copyModal() {
      if (!currentPaste) return;
      navigator.clipboard.writeText(currentPaste.content);
      alert("Đã copy nội dung!");
    }

    function downloadModal() {
      if (!currentPaste) return;
      const blob = new Blob([currentPaste.content], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${currentPaste.title.replace(/\s+/g,'_')}.txt`;
      a.click();
    }

    function shareModal() {
      if (!currentPaste) return;
      const base = window.location.origin + window.location.pathname;
      const rawLink = `${base}?raw=${currentPaste.id}`;
      document.getElementById("shareLink").textContent = rawLink;
      navigator.clipboard.writeText(rawLink);
      alert("Raw link đã copy vào clipboard!");
    }

    function newPaste() {
      document.getElementById("title").value = "";
      document.getElementById("content").value = "";
      window.location.hash = "";
    }

    function clearAll() {
      if (confirm("Bạn có chắc muốn xóa tất cả paste?")) {
        localStorage.removeItem("pastes");
        loadPastes();
      }
    }

    function goHome() {
      closeModal();
      window.location.hash = "";
    }

    // Xử lý khi mở trang với raw link
    window.addEventListener("load", () => {
      loadPastes();
      const urlParams = new URLSearchParams(window.location.search);
      const rawId = urlParams.get("raw");
      if (rawId) {
        let pastes = JSON.parse(localStorage.getItem("pastes") || "[]");
        let paste = pastes.find(p => p.id == rawId);
        if (paste) {
          document.body.innerHTML = `<pre class='language-javascript'><code>${
            paste.content.replace(/[&<>]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]))
          }</code></pre>`;
          Prism.highlightAll();
        }
      } else {
        const id = window.location.hash.slice(1);
        if (id) openPasteById(id);
      }
    });
  </script>
</body>
</html>
